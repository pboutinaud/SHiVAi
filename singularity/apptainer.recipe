Bootstrap: docker
From: tensorflow/tensorflow:2.13.0-gpu
Stage: build

%files
    ../../shivautils /usr/local/src/shivautils

%environment
    PATH=/usr/local/nvidia/bin:/usr/local/cuda/bin:/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin:/opt/ants-2.4.3/bin
    export PATH

%post
    # Installing shivautils
    apt update && apt-get install -y build-essential weasyprint libpangocairo-1.0-0 graphviz wget unzip
    chmod 755 /usr/local/src/shivautils/src/shivautils/scripts/*
    cd /usr/local/src/shivautils
    python -m pip install build
    python -m pip install .
    pip cache purge
    rm -rf /usr/local/src/shivautils

    # Installing ANTs
    cd /opt
    wget https://github.com/ANTsX/ANTs/releases/download/v2.4.3/ants-2.4.3-ubuntu-20.04-X64-gcc.zip 
    unzip ants-2.4.3-ubuntu-20.04-X64-gcc.zip
    rm ants-2.4.3-ubuntu-20.04-X64-gcc.zip

    # Installing niimath
    cd /usr/local/bin
    curl -fLO https://github.com/rordenlab/niimath/releases/latest/download/niimath_lnx.zip
    unzip niimath_lnx.zip
    rm niimath_lnx.zip

    # Installing Quickshear
    cd /usr/local/src/
    curl -fLO https://github.com/nipy/quickshear/archive/refs/heads/master.zip
    unzip master.zip
    pip install ./quickshear-master
    rm -rf ./quickshear-master
    rm master.zip

    mkdir -p /mnt/model

