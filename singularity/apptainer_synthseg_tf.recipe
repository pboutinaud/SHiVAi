Bootstrap: docker
From: tensorflow/tensorflow:2.0.4-gpu-py3
Stage: build

%files
    synthseg_models.zip /usr/local/

%environment
    PATH=/usr/local/nvidia/bin:/usr/local/cuda/bin:/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin
    export PATH
    alias mri_synthseg='python /usr/local/SynthSeg-master/scripts/commands/SynthSeg_predict.py'

%post
    rm /etc/apt/sources.list.d/cuda.list
    rm /etc/apt/sources.list.d/nvidia-ml.list
    apt-get update && apt-get -y install wget unzip
    cd /usr/local
    unzip synthseg_models.zip
    rm synthseg_models.zip
    wget https://github.com/BBillot/SynthSeg/archive/refs/heads/master.zip
    unzip master.zip
    rm master.zip
    mv 'synthseg models'/* SynthSeg-master/models/
    rm -r 'synthseg models'
    cd SynthSeg-master
    pip install keras==2.3.1 nibabel==3.2.2 matplotlib==3.3.4
    pip install . --no-dependencies

